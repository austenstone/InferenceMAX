name: PR Line Counter

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  count-lines:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      TARGET_FILE: utils/matrix-logic/generate_sweep_configs.py

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count lines in generate_sweep_configs.py
        id: line-count
        run: |
          if [ -f "$TARGET_FILE" ]; then
            LINE_COUNT=$(wc -l < "$TARGET_FILE")
            # If the last character is not a newline, increment the count
            if [ -n "$(tail -c 1 "$TARGET_FILE" | tr -d '\n')" ]; then
              LINE_COUNT=$((LINE_COUNT + 1))
            fi
            echo "line_count=$LINE_COUNT" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "line_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate summary
        run: |
          echo "## üìä Line Count Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE_EXISTS="${{ steps.line-count.outputs.file_exists }}"
          if [ "$FILE_EXISTS" == "true" ]; then
            LINE_COUNT="${{ steps.line-count.outputs.line_count }}"
            echo "**File:** \`$TARGET_FILE\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total Lines:** $LINE_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **File not found:** \`$TARGET_FILE\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fileExists = '${{ steps.line-count.outputs.file_exists }}';
            const lineCount = '${{ steps.line-count.outputs.line_count }}';
            const targetFile = process.env.TARGET_FILE;

            let commentBody;
            if (fileExists === 'true') {
              commentBody = `## üìä Line Count Report\n\n**File:** \`${targetFile}\`\n\n**Total Lines:** ${lineCount}`;
            } else {
              commentBody = `## üìä Line Count Report\n\n‚ö†Ô∏è **File not found:** \`${targetFile}\``;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
